version: '3.9'
name: vulcan-application
services:
  vulcan-go:
    image: golang:latest
    container_name: vulcan-go
    ports:
      - 443:443
      - 80:80
    networks:
      - vulcan_app
      - datadog_bridge
    environment:
      - DD_ENV=docker
      - DD_SERIVCE=vulcan-go
      - DD_APPSEC_ENABLED=true
      - DD_IAST_ENABLED=true
      - DD_AGENT_HOST=datadog-agent
      - DD_TRACE_AGENT_PORT=8126
      - DD_TRACE_CLIENT_IP_ENABLED=true
      - VULCAN_SESSION_KEY=2PbmuNW_uRkaf6Kux!ByK!yT!UmMZZ9B
    working_dir: /usr/vulcan
    volumes:
      - ./:/usr/vulcan/
      - /tmp/vulcan-logs:/usr/vulcan/logs
    command: bash -c "export VULCAN_COMMIT_SHA=$(git rev-parse HEAD) && go mod download && go mod verify && go build -o /usr/local/bin/vulcan -tags appsec ./services/golang/... && vulcan"
    labels:
      com.datadoghq.ad.logs: '[{"type":"file","source":"vulcan-app","service":"vulcan-go","path":"/vulcan-logs/golang.log"}]'
      com.datadoghq.ad.tags: '["env:docker","service:vulcan-go"]'
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 2G
  vulcan-js:
    image: node:18
    container_name: vulcan-js
    ports:
      - 4430:443
    networks:
      - vulcan_app
      - datadog_bridge
    environment:
      - DD_ENV=docker
      - DD_SERIVCE=vulcan-js
      - DD_IAST_ENABLED=true
      - DD_AGENT_HOST=datadog-agent
      - DD_TRACE_AGENT_PORT=8126
      - DD_TRACE_CLIENT_IP_ENABLED=true
      - DD_TRACE_STARTUP_LOGS=true
      - VULCAN_SESSION_KEY=2PbmuNW_uRkaf6Kux!ByK!yT!UmMZZ9B
    working_dir: /usr/vulcan
    volumes:
      - ./:/usr/vulcan/
      - /tmp/vulcan-logs:/usr/vulcan/logs
    command: bash -c "export VULCAN_COMMIT_SHA=$(git rev-parse HEAD) && npm install . && node ./services/node/app.js"
    labels:
      com.datadoghq.ad.logs: '[{"type":"file","source":"vulcan-app","service":"vulcan-js","path":"/vulcan-logs/node.log"}]'
      com.datadoghq.ad.tags: '["env:docker","service:vulcan-js"]'
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 2G
  vulcan-java:
    image: maven:3.9-eclipse-temurin-17
    container_name: vulcan-java
    ports:
      - 4431:443
    networks:
      - vulcan_app
      - datadog_bridge
    environment:
      - DD_ENV=docker
      - DD_SERIVCE=vulcan-java
      - DD_AGENT_HOST=datadog-agent
      - DD_TRACE_AGENT_PORT=8126
      - DD_TRACE_CLIENT_IP_ENABLED=true
      - VULCAN_SESSION_KEY=2PbmuNW_uRkaf6Kux!ByK!yT!UmMZZ9B
    working_dir: /usr/vulcan
    volumes:
      - ./:/usr/vulcan/
      - /tmp/vulcan-logs:/usr/vulcan/logs
    command: bash -c "wget -nc -O /usr/src/dd-java-agent.jar https://dtdg.co/latest-java-tracer; mvn install && java -javaagent:/usr/src/dd-java-agent.jar -Ddd.env=docker -Ddd.service=vulcan-java -Ddd.version=1.2.1 -Ddd.profiling.enabled=true -Ddd.appsec.enabled=true -Ddd.iast.enabled=true -Ddd.service.mapping=redis:session-store,postgresql:user-database,mongo:god-database -Ddd.tags=git.commit.sha:$(git rev-parse HEAD),git.repository_url:github.com/MatthewBrazill/vulcan-testing-app -jar ./target/vulcan.jar"
    labels:
      com.datadoghq.ad.logs: '[{"type":"file","source":"vulcan-app","service":"vulcan-java","path":"/vulcan-logs/java.log"}]'
      com.datadoghq.ad.tags: '["env:docker","service:vulcan-java"]'
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 2G
  god-database:
    image: mongo:latest
    container_name: god-database
    ports:
      - 27017:27017
    networks:
      - vulcan_app
      - datadog_bridge
    volumes:
      - ./database/gods:/data/db
    labels:
      com.datadoghq.ad.check_names: '["mongo"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"hosts":["%%host%%:%%port%%"],"username":"datadog","password":"5aae8c35f7e16245","database":"vulcan"}]'
      com.datadoghq.ad.logs: '[{"source":"mongodb","service":"god-database"}]'
      com.datadoghq.ad.tags: '["env:docker","service:god-database"]'
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 4G
  user-database:
    image: postgres:latest
    container_name: user-database
    ports:
      - 5432:5432
    networks:
      - vulcan_app
      - datadog_bridge
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - ./database/users:/var/lib/postgresql/data
    labels:
      com.datadoghq.ad.check_names: '["postgres"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"host":"%%host%%","port":5432,"username":"datadog","password":"5aae8c35f7e16245"}]'
      com.datadoghq.ad.logs: '[{"source":"postgresql","service":"user-database"}]'
      com.datadoghq.ad.tags: '["env:docker","service:user-database"]'
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 4G
  session-store:
    image: redis/redis-stack-server:latest
    container_name: session-store
    ports:
      - 6379:6379
    networks:
      - vulcan_app
      - datadog_bridge
    volumes:
      - ./database/sessions:/data
    labels:
      com.datadoghq.ad.check_names: '["redisdb"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"host":"%%host%%","port":"6379","password":""}]'
      com.datadoghq.ad.logs: '[{"source":"redis","service":"session-store"}]'
      com.datadoghq.ad.tags: '["env:docker","service:session-store"]'
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 4G
networks:
  vulcan_app:
    name: vulcan_app
  datadog_bridge:
    name: datadog_bridge
    external: true